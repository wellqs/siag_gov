{% extends "nsp/base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <h2 class="mb-3 mb-md-0 text-primary fw-bold">Dashboard NSP - Segurança do Paciente</h2>

    <form class="row g-2" id="filterForm" method="get">
      <div class="col-auto">
        <select id="anoSelect" name="ano" class="form-select form-select-sm shadow-sm">
          {% for ano in anos %}
            <option value="{{ ano }}" {% if ano == ano_selecionado %}selected{% endif %}>{{ ano }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <select id="mesSelect" class="form-select form-select-sm shadow-sm" name="mes">
          {% for num, nome in meses %}
            <option value="{{ num }}" {% if num == mes_selecionado %}selected{% endif %}>{{ nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <select id="setorSelect" class="form-select form-select-sm shadow-sm">
          <option value="">Todos os setores</option>
          {% for setor in setores %}
            <option value="{{ setor }}">{{ setor }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary btn-sm shadow-sm" type="submit">
            <i class="bi bi-filter"></i> Filtrar
        </button>
      </div>
    </form>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Eventos Adversos notificados ao NSP</div>
          <div class="fs-2 fw-bold text-dark text-center flex-fill d-flex align-items-center justify-content-center" id="val-total-ea-nsp">{{ stats.total_ea_nsp }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Eventos Adversos enviados ao NOTIVISA</div>
          <div class="fs-2 fw-bold text-dark text-center flex-fill d-flex align-items-center justify-content-center" id="val-total-ea-notivisa">{{ stats.total_ea_notivisa }}</div>
          <div class="text-center text-muted" style="font-size: 0.75rem;">
            <span id="val-ratio">{{ stats.total_ea_notivisa }}</span> / <span id="val-ratio-total">{{ stats.total_ea_nsp }}</span> enviadas
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Taxa de conformidade ID</div>
          <div class="fs-2 fw-bold text-success text-center flex-fill d-flex align-items-center justify-content-center" id="val-taxa-conformidade">{{ stats.taxa_conformidade }}%</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Pacientes avaliados</div>
          <div class="fs-2 fw-bold text-dark text-center flex-fill d-flex align-items-center justify-content-center" id="val-total-pacientes">{{ stats.total_pacientes }}</div>
          <div class="text-center text-muted" style="font-size: 0.75rem;">
            <span id="val-pulseiras">{{ stats.total_pulseiras }}</span> com pulseira correta
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Eventos de queda</div>
          <div class="fs-2 fw-bold text-danger text-center flex-fill d-flex align-items-center justify-content-center" id="val-ea-queda">{{ stats.total_ea_queda }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-2">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="text-muted mb-2" style="font-size: 0.85rem; line-height: 1.2;">Eventos por flebite</div>
          <div class="fs-2 fw-bold text-warning text-center flex-fill d-flex align-items-center justify-content-center" id="val-ea-flebite">{{ stats.total_ea_flebite }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <span>Evolução dos eventos adversos ({{ ano_selecionado }})</span>
        </div>
        <div class="card-body">
          <canvas id="lineEventos"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
          <strong>Conformidade de identificação</strong>
        </div>
        <div class="card-body" style="height: 250px; display: flex; justify-content: center;">
          <canvas id="doughnutIdentificacao"></canvas>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <strong>Distribuição de tipos de eventos</strong>
        </div>
        <div class="card-body">
          <canvas id="barDistribuicao"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

{{ stats|json_script:"stats-data" }}
{{ chart_data|json_script:"chart-data" }}

{% endblock %}

{% block extra_js %}
<script>
    const stats = JSON.parse(document.getElementById("stats-data").textContent);
    const chartData = JSON.parse(document.getElementById("chart-data").textContent);

    document.addEventListener("DOMContentLoaded", () => {
        const ctxLine = document.getElementById("lineEventos").getContext("2d");
        new Chart(ctxLine, {
            type: "line",
            data: {
                labels: chartData.chart_labels,
                datasets: [
                    { label: "Eventos Adversos (NSP)", data: chartData.chart_ea_nsp, tension: 0.3, borderColor: "#0d6efd", backgroundColor: "rgba(13, 110, 253, 0.1)", fill: true },
                    { label: "Eventos Adversos (NOTIVISA)", data: chartData.chart_ea_notivisa, tension: 0.3, borderColor: "#6c757d", borderDash: [5, 5] },
                    { label: "Quedas", data: chartData.chart_ea_queda, tension: 0.3, borderColor: "#dc3545" },
                    { label: "Flebite", data: chartData.chart_ea_flebite, tension: 0.3, borderColor: "#ffc107" },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: "bottom" } },
                scales: { y: { beginAtZero: true } }
            }
        });

        const ctxDoughnut = document.getElementById("doughnutIdentificacao").getContext("2d");
        new Chart(ctxDoughnut, {
            type: "doughnut",
            data: {
                labels: ["Correta", "Incorreta/sem pulseira"],
                datasets: [{
                    data: [
                        stats.total_pulseiras,
                        stats.total_pacientes - stats.total_pulseiras
                    ],
                    backgroundColor: ["#198754", "#dc3545"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: "bottom" } }
            }
        });

        const ctxBar = document.getElementById("barDistribuicao").getContext("2d");
        new Chart(ctxBar, {
            type: "bar",
            data: {
                labels: ["Eventos Adversos (NSP)", "Eventos Adversos (NOTIVISA)", "Queda", "Flebite"],
                datasets: [{
                    data: [
                        stats.total_ea_nsp,
                        stats.total_ea_notivisa,
                        stats.total_ea_queda,
                        stats.total_ea_flebite
                    ],
                    backgroundColor: ["#0d6efd", "#6c757d", "#dc3545", "#ffc107"]
                }]
            },
            options: {
                indexAxis: "y",
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });
    });
</script>
{% endblock %}
